<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

  <meta charset="UTF-8">
  <title>Work Permit Form</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f5f6fa;
      color: #2c3e50;
      line-height: 1.4;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .header-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    h2 {
      color: #2c3e50;
      font-size: 1.8rem;
      margin: 0;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .dropdown-container {
      position: relative;
      display: inline-block;
    }

    .dropdown-btn {
      background: #3498db;
      color: white;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s ease;
      min-width: 160px;
      justify-content: space-between;
    }

    .dropdown-btn:hover {
      background: #2980b9;
    }

    .dropdown-arrow {
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .dropdown-btn.active .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
      margin-top: 4px;
    }

    .dropdown-content.show {
      display: block;
    }

    .dropdown-item {
      display: block;
      padding: 12px 16px;
      color: #2c3e50;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }

    .dropdown-item:hover {
      background: #f8f9fa;
    }

    .dropdown-item.current {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 15px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    fieldset {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      background: white;
      margin: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: box-shadow 0.2s ease;
    }
    
    fieldset:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    legend {
      font-weight: 600;
      padding: 6px 12px;
      background: #2c3e50;
      color: white;
      border-radius: 4px;
      font-size: 0.85rem;
      border: none;
    }
    
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #2c3e50;
      font-size: 0.85rem;
    }
    
    input[type="text"], input[type="date"], input[type="time"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      transition: border-color 0.2s ease;
      background: white;
      margin-bottom: 10px;
    }
    
    input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
    }
    
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      accent-color: #3498db;
      cursor: pointer;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background 0.2s ease;
    }
    
    .checkbox-item:hover {
      background: #f8f9fa;
    }
    
    .checkbox-item label {
      margin-bottom: 0;
      cursor: pointer;
      flex-grow: 1;
    }
    
    .others-input {
      flex-grow: 1;
      margin-left: 10px;
      margin-bottom: 0 !important;
    }
    
    .schedule-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: end;
    }
    
    .long-input { 
      width: 100%; 
    }
    
    button {
      padding: 6px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .delete-btn {
      background: #e74c3c;
      color: white;
      padding: 5px 10px;
      font-size: 11px;
    }
    
    .delete-btn:hover { 
      background: #c0392b;
    }
    
    .add-btn {
      background: #27ae60;
      color: white;
      margin-top: 10px;
    }
    
    .add-btn:hover { 
      background: #219a52;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    th {
      background: #34495e;
      color: white;
      padding: 8px 8px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
    }
    
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .submit-btn {
      grid-column: 1 / -1;
      text-align: center;
      margin-top: 15px;
    }
    
    .submit-btn input {
      background: #3498db;
      color: white;
      padding: 12px 28px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
      min-width: 180px;
    }
    
    .submit-btn input:hover { 
      background: #2980b9;
    }
    
    .form-group {
      margin-bottom: 10px;
    }
    
    .schedule-section {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin: 8px 0;
      border-left: 3px solid #3498db;
    }
    
    .welding-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 12px;
      padding: 12px;
      background: #fff3cd;
      border-radius: 4px;
      border-left: 3px solid #f39c12;
    }
    
    .welding-left {
      display: flex;
      flex-direction: column;
    }
    
    .welding-right {
      display: flex;
      align-items: flex-start;
    }
    
    .welding-section .checkbox-item {
      margin-bottom: 6px;
    }
    
    .welding-section .form-group {
      margin-bottom: 0;
      width: 100%;
    }
    
    .fire-watchman-section {
      margin-top: 6px;
    }
    
    /* Compact sections */
    .compact {
      min-height: auto;
    }
    
    .compact .form-group:last-child {
      margin-bottom: 0;
    }
    
    .compact .checkbox-item:last-child {
      margin-bottom: 0;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      form {
        grid-template-columns: 1fr;
      }
      
      .schedule-row {
        grid-template-columns: 1fr;
        gap: 6px;
      }

      .header-container {
        flex-direction: column;
        gap: 15px;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 8px;
      }
      
      h2 {
        font-size: 1.6rem;
      }
      
      fieldset {
        padding: 12px;
      }
      
      form {
        gap: 12px;
      }

      .dropdown-btn {
        min-width: 140px;
        font-size: 13px;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <h2>Work Permit Form</h2>
      <div class="dropdown-container">
        <button class="dropdown-btn" onclick="toggleDropdown()">
          <span>Select Form Type</span>
          <span class="dropdown-arrow">â–¼</span>
        </button>
        <div class="dropdown-content" id="dropdownContent">
          <button class="dropdown-item" onclick="navigateToForm('form2')">DC Internal Gate Pass Form</button>
          <button class="dropdown-item" onclick="navigateToForm('form3')">NEO Gate Pass Form</button>
          <button class="dropdown-item" onclick="navigateToForm('form4')">DC Gate Pass Form</button>
        </div>
      </div>
    </div>
    
    <form>

      <!-- General Info -->
      <fieldset class="compact">
        <legend>General Information</legend>
        <div class="form-group">
          <label>Tenant Name:</label>
          <input type="text" name="tenant_name">
        </div>
        <div class="form-group">
          <label>Location / Floor / Unit#:</label>
          <input type="text" name="location">
        </div>
        <div class="form-group">
          <label>Name of Contractor:</label>
          <input type="text" name="contractor_name">
        </div>
        <div class="form-group">
          <label>Person In-Charge:</label>
          <input type="text" name="person_in_charge">
        </div>
        <div class="form-group">
          <label>Telephone Numbers:</label>
          <input type="text" name="telephone">
        </div>
      </fieldset>

      <!-- Nature of Work -->
      <fieldset class="compact">
        <legend>Nature of Work</legend>
        <div class="checkbox-item">
          <input type="checkbox" name="civil_etc" id="civil">
          <label for="civil">Civil / Carpentry / Repainting</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" name="electrical" id="electrical">
          <label for="electrical">Electrical</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" name="communication" id="communication">
          <label for="communication">Communications</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" name="mechanical" id="mechanical">
          <label for="mechanical">Mechanical</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" name="others_chckbx" id="others">
          <label for="others">Others:</label>
          <input type="text" name="others_txt" class="others-input" placeholder="Please specify">
        </div>
        
        <div class="checkbox-item">
          <input type="checkbox" name="w_welding" id="welding">
          <label for="welding">With Welding/Hot Works</label>
        </div>
        
        <div class="fire-watchman-section">
          <div class="form-group">
            <label>Fire Watchman:</label>
            <input type="text" name="fire_watchman" placeholder="Name of fire watchman">
          </div>
        </div>
        
        <div class="checkbox-item">
          <input type="checkbox" name="need_access" id="access">
          <label for="access">Need to access Building Restricted Areas</label>
        </div>
      </fieldset>

      <!-- Schedule -->
      <fieldset class="compact">
        <legend>Work Schedule</legend>
        <div class="schedule-section">
          <div class="schedule-row">
            <div class="form-group">
              <label>Date:</label>
              <input type="date" name="date">
            </div>
            <div></div>
          </div>
          <div class="schedule-row">
            <div class="form-group">
              <label>Start Date:</label>
              <input type="date" name="start_date">
            </div>
            <div class="form-group">
              <label>Start Time:</label>
              <input type="time" name="start_time">
            </div>
          </div>
          <div class="schedule-row">
            <div class="form-group">
              <label>End Date:</label>
              <input type="date" name="end_date">
            </div>
            <div class="form-group">
              <label>End Time:</label>
              <input type="time" name="end_time">
            </div>
          </div>
        </div>
      </fieldset>

         <!-- Signatories -->
      <fieldset class="compact">
        <legend>Signatories</legend>
        <div class="form-group">
          <label>Prepared By:</label>
          <input type="text" name="prepared_by">
        </div>
        <div class="form-group">
          <label>Requested by (Authorized Tenant Representative):</label>
          <input type="text" name="requested_by">
        </div>
        <div class="form-group">
          <label>Endorsed by (Property/Chief Engineer):</label>
          <input type="text" name="endorsed_by">
        </div>
        <div class="form-group">
          <label>Approved by (Property Manager):</label>
          <input type="text" name="approved_by">
        </div>
      </fieldset>

      

      <!-- Workers and Work Descriptions in 2 columns -->
      <div class="full-width" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <!-- Workers -->
        <fieldset>
          <legend>List of Workers / Personnel</legend>
          <table id="workersTable">
            <tr><th>#</th><th>Name</th><th>Action</th></tr>
            <tr>
              <td>1</td>
              <td><input type="text" name="name1" class="long-input" placeholder="Enter worker name"></td>
              <td><button type="button" class="delete-btn" onclick="deleteRow(this, 'workers')">Remove</button></td>
            </tr>
          </table>
          <button type="button" class="add-btn" onclick="addRow('workers')">Add Personnel</button>
        </fieldset>

        <!-- Work Descriptions -->
        <fieldset>
          <legend>Work Descriptions</legend>
          <table id="workdescTable">
            <tr><th>#</th><th>Work Description</th><th>Action</th></tr>
            <tr>
              <td>1</td>
              <td><input type="text" name="workdesc1" class="long-input" placeholder="Describe work responsibilities"></td>
              <td><button type="button" class="delete-btn" onclick="deleteRow(this, 'workdesc')">Remove</button></td>
            </tr>
          </table>
          <button type="button" class="add-btn" onclick="addRow('workdesc')">Add Work Description</button>
        </fieldset>
      </div>

      <!-- Materials -->
      <fieldset class="full-width">
        <legend>List of Materials</legend>
        <table id="materialsTable">
          <tr><th>#</th><th>Quantity</th><th>Description</th><th>Action</th></tr>
          <tr>
            <td>1</td>
            <td><input type="text" name="matquan1" placeholder="Qty"></td>
            <td><input type="text" name="matdesc1" class="long-input" placeholder="Material description"></td>
            <td><button type="button" class="delete-btn" onclick="deleteRow(this, 'materials')">Remove</button></td>
          </tr>
        </table>
        <button type="button" class="add-btn" onclick="addRow('materials')">Add Material</button>
      </fieldset>

      <!-- Tools -->
      <fieldset class="full-width">
        <legend>List of Tools</legend>
        <table id="toolsTable">
          <tr><th>#</th><th>Quantity</th><th>Description</th><th>Action</th></tr>
          <tr>
            <td>1</td>
            <td><input type="text" name="toolquan1" placeholder="Qty"></td>
            <td><input type="text" name="tooldesc1" class="long-input" placeholder="Tool description"></td>
            <td><button type="button" class="delete-btn" onclick="deleteRow(this, 'tools')">Remove</button></td>
          </tr>
        </table>
        <button type="button" class="add-btn" onclick="addRow('tools')">Add Tool</button>
      </fieldset>

      <div class="submit-btn">
        <input type="submit" value="Submit Application">
      </div>
    </form>
  </div>

  <script>
    const limits = { workers: 9, workdesc: 9, materials: 8, tools: 8 };

    // Dropdown functionality
    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownContent');
      const button = document.querySelector('.dropdown-btn');
      
      dropdown.classList.toggle('show');
      button.classList.toggle('active');
    }

    function navigateToForm(formType) {
      // Close dropdown
      document.getElementById('dropdownContent').classList.remove('show');
      document.querySelector('.dropdown-btn').classList.remove('active');
      
      // Handle navigation based on form type
      switch(formType) {
        case 'form2':
          // Replace 'form2.html' with your actual file name
          window.location.href = 'smic_gatepass.html';
          break;
        case 'form3':
          // Replace 'form3.html' with your actual file name  
          window.location.href = 'gate_pass.html';
          break;
        case 'form4':
          // Replace 'form3.html' with your actual file name  
          window.location.href = 'smic_gate_pass4_1.html';
          break;  
        default:
          console.log('Unknown form type:', formType);
      }
    }

    // Close dropdown when clicking outside
    window.addEventListener('click', function(event) {
      if (!event.target.matches('.dropdown-btn') && !event.target.closest('.dropdown-container')) {
        const dropdown = document.getElementById('dropdownContent');
        const button = document.querySelector('.dropdown-btn');
        dropdown.classList.remove('show');
        button.classList.remove('active');
      }
    });

    // Function to format date to word format (e.g., "January 15, 2024")
    function formatDateToWords(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    // Function to format date with abbreviated months (e.g., "Dec 15, 2024")
    function formatDateToWordsShort(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    // Function to format time to 12-hour format (e.g., "2:30 PM")
    function formatTimeTo12Hour(timeString) {
      if (!timeString) return '';
      const [hours, minutes] = timeString.split(':');
      const hour24 = parseInt(hours);
      const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
      const ampm = hour24 >= 12 ? 'PM' : 'AM';
      return `${hour12}:${minutes} ${ampm}`;
    }

    function addRow(type) {
      const table = document.getElementById(type + "Table");
      const rowCount = table.rows.length - 1;
      if (rowCount >= limits[type]) {
        alert("Maximum " + limits[type] + " " + type + " allowed");
        return;
      }

      const row = table.insertRow();
      if (type === "workers") {
        row.innerHTML = `
          <td></td>
          <td><input type="text" class="long-input" placeholder="Enter worker name"></td>
          <td><button type="button" class="delete-btn" onclick="deleteRow(this, 'workers')">Remove</button></td>
        `;
      } else if (type === "workdesc") {
        row.innerHTML = `
          <td></td>
          <td><input type="text" class="long-input" placeholder="Describe work responsibilities"></td>
          <td><button type="button" class="delete-btn" onclick="deleteRow(this, 'workdesc')">Remove</button></td>
        `;
      } else if (type === "materials") {
        row.innerHTML = `
          <td></td>
          <td><input type="text" placeholder="Qty"></td>
          <td><input type="text" class="long-input" placeholder="Material description"></td>
          <td><button type="button" class="delete-btn" onclick="deleteRow(this, 'materials')">Remove</button></td>
        `;
      } else if (type === "tools") {
        row.innerHTML = `
          <td></td>
          <td><input type="text" placeholder="Qty"></td>
          <td><input type="text" class="long-input" placeholder="Tool description"></td>
          <td><button type="button" class="delete-btn" onclick="deleteRow(this, 'tools')">Remove</button></td>
        `;
      }
      reindex(type);
    }

    function deleteRow(btn, type) {
      const table = document.getElementById(type + "Table");
      if (table.rows.length <= 2) {
        alert("At least 1 row must remain.");
        return;
      }
      table.deleteRow(btn.parentNode.parentNode.rowIndex);
      reindex(type);
    }

    function reindex(type) {
      const table = document.getElementById(type + "Table");
      for (let i = 1; i < table.rows.length; i++) {
        const row = table.rows[i];
        row.cells[0].innerText = i;
        if (type === "workers") {
          row.cells[1].children[0].setAttribute("name", "name" + i);
        } else if (type === "workdesc") {
          row.cells[1].children[0].setAttribute("name", "workdesc" + i);
        } else if (type === "materials") {
          row.cells[1].children[0].setAttribute("name", "matquan" + i);
          row.cells[2].children[0].setAttribute("name", "matdesc" + i);
        } else if (type === "tools") {
          row.cells[1].children[0].setAttribute("name", "toolquan" + i);
          row.cells[2].children[0].setAttribute("name", "tooldesc" + i);
        }
      }
    }

    document.querySelector("form").addEventListener("submit", async function(e) {
      e.preventDefault(); // stop normal submit

      try {
        // Gather form data
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Format dates and times before sending to PDF
        const dateFields = ['date'];
        const shortDateFields = ['start_date', 'end_date'];
        const timeFields = ['start_time', 'end_time'];

        dateFields.forEach(field => {
          if (data[field]) {
            data[field] = formatDateToWords(data[field]);
          }
        });

        shortDateFields.forEach(field => {
          if (data[field]) {
            data[field] = formatDateToWordsShort(data[field]);
          }
        });

        timeFields.forEach(field => {
          if (data[field]) {
            data[field] = formatTimeTo12Hour(data[field]);
          }
        });
        
        // Load your PDF template
        const existingPdfBytes = await fetch("NEO_Work_Permit_Form.pdf")
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.arrayBuffer();
          });
        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
        const formPdf = pdfDoc.getForm();

        // Get all checkboxes to handle checked state properly
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
        
        // Loop through all keys and fill if field exists in PDF
        for (const [key, value] of Object.entries(data)) {
          try {
            if (formPdf.getTextField(key)) {
              formPdf.getTextField(key).setText(value);
            } else if (formPdf.getCheckBox(key)) {
              formPdf.getCheckBox(key).check();
            }
          } catch (err) {
            console.log(`Skipping ${key}: ${err.message}`);
          }
        }

        // Handle checkboxes that might not be in FormData if unchecked
        checkboxes.forEach(checkbox => {
          try {
            if (formPdf.getCheckBox(checkbox.name)) {
              if (checkbox.checked) {
                formPdf.getCheckBox(checkbox.name).check();
              } else {
                formPdf.getCheckBox(checkbox.name).uncheck();
              }
            }
          } catch (err) {
            console.log(`Skipping checkbox ${checkbox.name}: ${err.message}`);
          }
        });

        // Save and download
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });

        // Convert to Base64 for email sending
        const base64Pdf = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(",")[1]);
          reader.readAsDataURL(blob);
        });

        // Send to Google Apps Script with proper error handling
        try {
          const emailResponse = await fetch("https://script.google.com/macros/s/AKfycbwpDwHYsM1POolSemzDbLFgJ55pLW-v_tol4Vfl8ETMdB62mZxP5MGHnHLZ7-FCpMyr/exec", {
            method: "POST",
            mode: "no-cors", // Important for Google Apps Script
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ 
  pdfBase64: base64Pdf,
  formData: data,
  formType: 'work_permit'
})
          });
          
          console.log("Email request sent successfully");
        } catch (emailError) {
          console.error("Email send error:", emailError);
          // Don't stop the process if email fails
        }

        // Download the PDF
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Work Permit.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert("Work Permit PDF generated successfully! Work permit application will be sent to the manager.");
        
      } catch (error) {
        console.error("Error generating PDF:", error);
        alert("Error generating PDF. Please make sure the NEO_Work_Permit_Form.pdf file is in the same folder as this HTML file. Error: " + error.message);
      }
    });

    reindex('workers');
    reindex('workdesc');
    reindex('materials');
    reindex('tools');
  </script>
</body>
</html>





