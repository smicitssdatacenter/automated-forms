<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gate Pass Form</title>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f5f6fa;
      color: #2c3e50;
      line-height: 1.4;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .header-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    h2 {
      color: #2c3e50;
      font-size: 1.8rem;
      margin: 0;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .dropdown-container {
      position: relative;
      display: inline-block;
    }

    .dropdown-btn {
      background: #3498db;
      color: white;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s ease;
      min-width: 160px;
      justify-content: space-between;
    }

    .dropdown-btn:hover {
      background: #2980b9;
    }

    .dropdown-arrow {
      font-size: 12px;
      transition: transform 0.2s ease;
    }

    .dropdown-btn.active .dropdown-arrow {
      transform: rotate(180deg);
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
      margin-top: 4px;
    }

    .dropdown-content.show {
      display: block;
    }

    .dropdown-item {
      display: block;
      padding: 12px 16px;
      color: #2c3e50;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s ease;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }

    .dropdown-item:hover {
      background: #f8f9fa;
    }

    .dropdown-item.current {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 15px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    fieldset {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      background: white;
      margin: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: box-shadow 0.2s ease;
    }
    
    fieldset:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    legend {
      font-weight: 600;
      padding: 6px 12px;
      background: #2c3e50;
      color: white;
      border-radius: 4px;
      font-size: 0.85rem;
      border: none;
    }
    
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #2c3e50;
      font-size: 0.85rem;
    }
    
    input[type="text"], input[type="date"], input[type="time"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      transition: border-color 0.2s ease;
      background: white;
      margin-bottom: 10px;
    }
    
    input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
    }
    
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      accent-color: #3498db;
      cursor: pointer;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background 0.2s ease;
    }
    
    .checkbox-item:hover {
      background: #f8f9fa;
    }
    
    .checkbox-item label {
      margin-bottom: 0;
      cursor: pointer;
      flex-grow: 1;
    }
    
    .schedule-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: end;
    }
    
    .long-input { 
      width: 100%; 
    }
    
    button {
      padding: 6px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .delete-btn {
      background: #e74c3c;
      color: white;
      padding: 5px 10px;
      font-size: 11px;
    }
    
    .delete-btn:hover { 
      background: #c0392b;
    }
    
    .add-btn {
      background: #27ae60;
      color: white;
      margin-top: 10px;
    }
    
    .add-btn:hover { 
      background: #219a52;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    th {
      background: #34495e;
      color: white;
      padding: 8px 8px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
    }
    
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .submit-btn {
      grid-column: 1 / -1;
      text-align: center;
      margin-top: 15px;
    }
    
    .submit-btn input {
      background: #3498db;
      color: white;
      padding: 12px 28px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
      min-width: 180px;
    }
    
    .submit-btn input:hover { 
      background: #2980b9;
    }
    
    .form-group {
      margin-bottom: 10px;
    }
    
    .delivery-section {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 4px;
      margin: 8px 0;
      border-left: 3px solid #3498db;
    }
    
    /* Compact sections */
    .compact {
      min-height: auto;
    }
    
    .compact .form-group:last-child {
      margin-bottom: 0;
    }
    
    .compact .checkbox-item:last-child {
      margin-bottom: 0;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      form {
        grid-template-columns: 1fr;
      }

      .header-container {
        flex-direction: column;
        gap: 15px;
      }
      
      .schedule-row {
        grid-template-columns: 1fr;
        gap: 6px;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 8px;
      }
      
      h2 {
        font-size: 1.6rem;
      }
      
      fieldset {
        padding: 12px;
      }
      
      form {
        gap: 12px;
      }

      .dropdown-btn {
        min-width: 140px;
        font-size: 13px;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <h2>NEO Gate Pass Form</h2>
      <div class="dropdown-container">
        <button class="dropdown-btn" onclick="toggleDropdown()">
          <span>Select Form Type</span>
          <span class="dropdown-arrow">â–¼</span>
        </button>
        <div class="dropdown-content" id="dropdownContent">
          <button class="dropdown-item" onclick="navigateToForm('form1')">Work Permit Form</button>
          <button class="dropdown-item" onclick="navigateToForm('form2')">DC Internal Gate Pass</button>
          <button class="dropdown-item current" onclick="navigateToForm('form3')">DC Gate Pass Form</button>
        </div>
      </div>
    </div>
    
    <form id="gatepassForm">

      <!-- General Info -->
      <fieldset class="compact">
        <legend>General Information</legend>
        <div class="form-group">
          <label>Unit No:</label>
          <input type="text" name="unit_no" placeholder="Enter unit number">
        </div>
        <div class="form-group">
          <label>Tenant:</label>
          <input type="text" name="tenant" placeholder="Enter tenant name">
        </div>
        <div class="form-group">
          <label>Carrier:</label>
          <input type="text" name="carrier" placeholder="Enter carrier name">
        </div>
      </fieldset>

      <!-- Delivery Type -->
      <fieldset class="compact">
        <legend>Delivery Information</legend>
        <div class="delivery-section">
          <div class="schedule-row">
            <div class="form-group">
              <label>Date:</label>
              <input type="date" name="date">
            </div>
            <div class="form-group">
              <label>Time:</label>
              <input type="time" name="time">
            </div>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" name="chckbox_delivery" id="delivery">
            <label for="delivery">Delivery</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" name="chckbox_pull" id="pullout">
            <label for="pullout">Pull-Out</label>
          </div>
          <div class="form-group" style="margin-top: 10px;">
            <label>Purpose of Gate Pass:</label>
            <input type="text" name="purpose" placeholder="Describe the purpose" style="width: 200%; max-width: 100%;">
          </div>
        </div>
      </fieldset>

      <!-- Other Info -->
      <fieldset class="compact">
        <legend>Additional Information</legend>
        <div class="form-group">
          <label>Elevator No:</label>
          <input type="text" name="elevator_no" placeholder="Enter elevator number">
        </div>
        <div class="form-group">
          <label>Remarks (Admin):</label>
          <input type="text" name="remarks_admin" placeholder="Administrative remarks">
        </div>
      </fieldset>

      <!-- Signatories -->
      <fieldset class="full-width">
        <legend>Signatories</legend>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
          <div class="form-group">
            <label>Requested by:</label>
            <input type="text" name="requested_by" placeholder="Name of requestor">
          </div>
          <div class="form-group">
            <label>Authorized by:</label>
            <input type="text" name="authorized_by" placeholder="Name of authorizer">
          </div>
          <div class="form-group">
            <label>Endorsed by:</label>
            <input type="text" name="endorsed_by" placeholder="Name of endorser">
          </div>
          <div class="form-group">
            <label>Approved by:</label>
            <input type="text" name="approved_by" placeholder="Name of approver">
          </div>
          <div class="form-group">
            <label>Verified by:</label>
            <input type="text" name="verified_by" placeholder="Name of verifier">
          </div>
        </div>
      </fieldset>

      <!-- Item List -->
      <fieldset class="full-width">
        <legend>Item List</legend>
        <table id="itemsTable">
          <tr><th>#</th><th>Quantity</th><th>Item</th><th>Remarks</th><th>Action</th></tr>
          <tr>
            <td>1</td>
            <td><input type="text" name="qt_1" placeholder="Qty"></td>
            <td><input type="text" name="item_1" class="long-input" placeholder="Item description"></td>
            <td><input type="text" name="remarks_1" class="long-input" placeholder="Additional remarks"></td>
            <td><button type="button" class="delete-btn" onclick="deleteRow(this)">Remove</button></td>
          </tr>
        </table>
        <button type="button" class="add-btn" onclick="addRow()">Add Item</button>
      </fieldset>

      <div class="submit-btn">
        <input type="submit" value="Generate Gate Pass PDF">
      </div>
    </form>
  </div>

  <script>
    const maxItems = 6;

    // ============ GOOGLE APPS SCRIPT CONFIGURATION ============
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxg0LKIMhZYQjSkUjf9tI1KtP6B45JCozP1KHlOL748FdLg_ssRUPv1yvCy0e_UTigM/exec';

    // Dropdown functionality
    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownContent');
      const button = document.querySelector('.dropdown-btn');
      
      dropdown.classList.toggle('show');
      button.classList.toggle('active');
    }

    function navigateToForm(formType) {
      // Close dropdown
      document.getElementById('dropdownContent').classList.remove('show');
      document.querySelector('.dropdown-btn').classList.remove('active');
      
      // Handle navigation based on form type
      switch(formType) {
        case 'form1':
          // Replace 'work_permit.html' with your actual file name
          window.location.href = 'index.html';
          break;
        case 'form2':
          // Replace 'smic_gatepass.html' with your actual file name  
          window.location.href = 'smic_gatepass.html';
          break;
        case 'form3':
          // Replace 'smic_gatepass.html' with your actual file name  
          window.location.href = 'smic_gate_pass4_1.html';
          break;
        default:
          console.log('Unknown form type:', formType);
      }
    }

    // Close dropdown when clicking outside
    window.addEventListener('click', function(event) {
      if (!event.target.matches('.dropdown-btn') && !event.target.closest('.dropdown-container')) {
        const dropdown = document.getElementById('dropdownContent');
        const button = document.querySelector('.dropdown-btn');
        dropdown.classList.remove('show');
        button.classList.remove('active');
      }
    });

    function addRow() {
      const table = document.getElementById("itemsTable");
      const rowCount = table.rows.length - 1;
      if (rowCount >= maxItems) {
        alert("Maximum " + maxItems + " items allowed");
        return;
      }

      const row = table.insertRow();
      row.innerHTML = `
        <td></td>
        <td><input type="text" placeholder="Qty"></td>
        <td><input type="text" class="long-input" placeholder="Item description"></td>
        <td><input type="text" class="long-input" placeholder="Additional remarks"></td>
        <td><button type="button" class="delete-btn" onclick="deleteRow(this)">Remove</button></td>
      `;
      reindex();
    }

    function deleteRow(btn) {
      const table = document.getElementById("itemsTable");
      if (table.rows.length <= 2) {
        alert("At least 1 item must remain.");
        return;
      }
      table.deleteRow(btn.parentNode.parentNode.rowIndex);
      reindex();
    }

    function reindex() {
      const table = document.getElementById("itemsTable");
      for (let i = 1; i < table.rows.length; i++) {
        const row = table.rows[i];
        row.cells[0].innerText = i;
        row.cells[1].children[0].setAttribute("name", "qt_" + i);
        row.cells[2].children[0].setAttribute("name", "item_" + i);
        row.cells[3].children[0].setAttribute("name", "remarks_" + i);
      }
    }

    // Format date and time functions
    function formatDateToWords(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const monthNames = [
        'Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.',
        'Jul.', 'Aug.', 'Sept.', 'Oct.', 'Nov.', 'Dec.'
      ];
      const month = monthNames[date.getMonth()];
      const day = date.getDate();
      const year = date.getFullYear();
      return `${month} ${day}, ${year}`;
    }

    function formatTimeTo12Hour(timeString) {
      if (!timeString) return '';
      const [hours, minutes] = timeString.split(':');
      const hour24 = parseInt(hours);
      const hour12 = hour24 === 0 ? 12 : hour24 > 12 ? hour24 - 12 : hour24;
      const ampm = hour24 >= 12 ? 'PM' : 'AM';
      return `${hour12}:${minutes} ${ampm}`;
    }

    document.getElementById("gatepassForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      try {
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Format date and time
        if (data.date) {
          data.date = formatDateToWords(data.date);
        }
        if (data.time) {
          data.time = formatTimeTo12Hour(data.time);
        }

        // Load PDF
        const existingPdfBytes = await fetch("NEO_Gate_Pass_Form_Nov_2024.pdf")
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.arrayBuffer();
          });
        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
        const formPdf = pdfDoc.getForm();

        // Get all checkboxes to handle checked state properly
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');

        // Fill both sets of fields (since form is duplicated)
        for (const [key, value] of Object.entries(data)) {
          const fields = formPdf.getFields().filter(f => f.getName() === key);
          for (const field of fields) {
            try {
              if (field.setText) field.setText(value);
              if (field.check && value === "on") field.check();
            } catch (err) {
              console.log(`Skipping ${key}: ${err.message}`);
            }
          }
        }

        // Handle checkboxes that might not be in FormData if unchecked
        checkboxes.forEach(checkbox => {
          try {
            const fields = formPdf.getFields().filter(f => f.getName() === checkbox.name);
            fields.forEach(field => {
              if (field.check && field.uncheck) {
                if (checkbox.checked) {
                  field.check();
                } else {
                  field.uncheck();
                }
              }
            });
          } catch (err) {
            console.log(`Skipping checkbox ${checkbox.name}: ${err.message}`);
          }
        });

        // Save and download
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Gate_Pass_Filled.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Convert to Base64 for email sending
        const base64Pdf = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(",")[1]);
          reader.readAsDataURL(blob);
        });

        // Send to Google Apps Script with proper error handling
        try {
          console.log('Sending gate pass email...');
          console.log('Tenant name:', data.tenant || 'Unknown');
          
          const emailResponse = await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors", // Important for Google Apps Script
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ 
              pdfBase64: base64Pdf,
              formData: data, // Send form data for email subject/content
              formType: 'gate_pass'
            })
          });
          
          console.log("Gate pass email request sent successfully");
          alert("Gate Pass PDF generated successfully! Gate pass application will be sent to the manager.");
        } catch (emailError) {
          console.error("Email send error:", emailError);
          alert("Gate Pass PDF generated successfully! However, there was an issue sending the email notification. Error: " + emailError.message);
        }
        
      } catch (error) {
        console.error("Error generating PDF:", error);
        alert("Error generating PDF. Please make sure the NEO_Gate_Pass_Form_Nov_2024.pdf file is in the same folder as this HTML file. Error: " + error.message);
      }
    });

    // Initialize row indexing
    reindex();
  </script>
</body>

</html>


